apiVersion: ops.plivo.com/v1alpha1
kind: WebService
metadata:
  name: nginx
  namespace: devops
  annotations:
    filepath: clusters/pre-prod/pre-prod-us-east-1/tenants/devops/devops-common/nginx
spec:
  replicas: 1
  resources:
    requests:
      cpu: "100m"
      memory: "100Mi"
    limits:
      cpu: "100m"
      memory: "100Mi"
  entrypoint:
    command: []
    args: []
  autoscaling:
    controller: HorizontalPodAutoscaler
    maxReplicas: 100
    minReplicas: 1
    averageCPUUtilizationTarget: 70
    averageMemoryUtilizationTarget: 70
  persistence:
    enabled: false
    storageClass: gp3
    storageSize: 10
    mountPath: /data
  deployment:
    automateImageUpdates: false
    applicationRepositoryBranch: main
  loadbalancing:
    useCommonLoadbalancer: true
    public: false
    externalDNSNames: []
    customListenerRules: []
    listenerPorts: 
      - 443
    targetGroup:
      healthcheck:
        path: /
        initialDelaySeconds: 0
  securityContext:
    runAsUser: 10001
    runAsNonRoot: true
    runAsGroup: 10001
  consul: "https://consul.non-prod.plivops.com"
  containerPort: 80
  image: "nginx:latest"
  advanced:
    additionalEnvVars: {}
  configuration: 
    - name: devops-common-nginx-externalsecret
      usageMethod: AsEnvVariables
      sensitive: true
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: devops-common-nginx-externalsecret
  namespace: devops
  annotations:
    filepath: clusters/pre-prod/pre-prod-us-east-1/tenants/devops/devops-common/nginx
spec:
  secretStoreRef:
    name: devops
    kind: SecretStore
  target:
    creationPolicy: owner
    template:
      engineVersion: v2
      data: 
        painter: "{{ .painter }}"
        debugger: "{{ .debugger }}"
  data: 
    - secretKey: painter
      remoteRef: 
        key: pre-prod/devops/pgadmin/LDAP_BIND_PASSWORD
    - secretKey: debugger
      remoteRef: 
        key: pre-prod/devops/pgadmin/PGADMIN_DEFAULT_PASSWORD
